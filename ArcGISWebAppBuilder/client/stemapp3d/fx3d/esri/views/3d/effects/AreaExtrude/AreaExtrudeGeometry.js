/**
 * Copyright @ 2020 Esri.
 * All rights reserved under the copyright laws of the United States and applicable international laws, treaties, and conventions.
 */
define(["dojo/_base/declare","esri/geometry/support/centroid","esri/core/libs/earcut/earcut","esri/core/libs/gl-matrix-2/vec3f64","esri/core/libs/gl-matrix-2/vec3","../../support/geometryUtils","esri/geometry/support/triangulationUtils","esri/geometry/projection"],function(t,e,n,i,r,p,s,o){function a(t,e){var n=s.pathsToTriangulationInfo(t,e);return{vertexData:n.position,polygons:n.polygons,outlines:n.outlines}}function d(t,e,n,i,r,p,s){return o.projectBuffer(t,n,e,i,p,r,s)}var h=i.vec3f64,r=r.vec3,u=h.create(),c=h.create(),l=h.create(),x=h.create(),f=h.create(),g=h.create(),v=h.create(),m=h.create(),y=6378137,_={Down:0,Up:1},b=Math.cos(5*(Math.PI/180)),D=100.11,E=t(null,{constructor:function(t,n,i){var r=t.geometry.rings,p={rings:r,hasZ:!1};this.center=e.polygonCentroid(p),this._geometryData=a(r,t.geometry.hasZ),this._geometryData&&n>=0&&i>=0&&(this.index=n,this.stride=i)},createBuffers:function(t,e){var i,r,s,o,a,h,u,c,l=this._geometryData.polygons,x=[],f=this._geometryData.vertexData;if(!f)return x;var g=f.length/3,v=new Float64Array(f.length);d(f,0,t,v,0,e,g);for(var m=new Float64Array(v),y=0;y<l.length;++y){i=l[y],u=i.count,c=i.index;var b=new Float64Array(f.buffer,3*c*f.BYTES_PER_ELEMENT,3*u);if(r=i.holeIndices.map(function(t){return t-c}),s=n.earcut(b,r,3),!(s.length<1)){var E={polygonIndex:y},U=new Float64Array(m.buffer,3*c*m.BYTES_PER_ELEMENT,3*u),w=this._computeNormalAndDistance(U);E.dist=w.distance;var z=p.getOrigin(v,g,c,u);if(z){E.origin=z;var A=[],N=[];o=i.count,a=2*o;for(var M=0;M<o;M++)h=M*this.stride,A[0+h]=b[0+3*M],A[1+h]=b[1+3*M],A[2+h]=1,A[3+h]=this.index,A[4+h]=_.Down,A[5+h]=this.center[0],A[6+h]=this.center[1],h=(M+o)*this.stride,A[0+h]=b[0+3*M],A[1+h]=b[1+3*M],A[2+h]=D,A[3+h]=this.index,A[4+h]=_.Up,A[5+h]=this.center[0],A[6+h]=this.center[1];for(var F=0,T=0,j=0;j<i.pathLengths.length;j++){T=i.pathLengths[j];for(var B=0;B<T;B++)B!==T-1?N.push(B+1+F,B+F,B+1+o+F,B+1+o+F,B+F,B+o+F):N.push(0+F,B+F,0+o+F,0+o+F,B+F,B+o+F);F+=T}this._subdivision2(b,U,s,o,A,N),E.indexNums=N.length,E.vertexNum=A.length/this.stride,E.vertices=new Float32Array(A),E.indices=new Uint32Array(N),x.push(E)}}}return x},_computeNormalAndDistance:function(t){var e=0,n=3,i=6;r.set(u,t[e++],t[e++],t[e++]),r.set(c,t[n++],t[n++],t[n++]),r.set(l,t[i++],t[i++],t[i++]),r.subtract(x,u,c),r.subtract(f,l,c);var p=h.create();r.cross(p,x,f),r.normalize(p,p);var s=Math.abs(r.dot(p,u)),o=y-s,a=r.normalize(u,u),d=r.dot(p,a),g=Math.abs(o/d);return{normal:p,distance:g}},_subdivision:function(t,e,n,i,r,p){for(var s,o,a,d,h,u,c,l,x=e.length/3,f=0,g=0,v=0;v<x;v++)d=e[f++],h=e[f++],u=e[f++],s=3*d,o=3*h,a=3*u,c=(t[s]+t[o]+t[a])/3,l=(t[s+1]+t[o+1]+t[a+1])/3,r.push(c,l,D,this.index,_.Up,this.center[0],this.center[1]),p.push(d+n,h+n,i+g),p.push(h+n,u+n,i+g),p.push(u+n,d+n,i+g),g++},_doSubdivision:function(t,e,n){if(t.length>0)for(var i,p,s,o,a,d,u,c,l,x,f=-1,y=e.length/this.stride;null!=(i=t.pop());)if(r.copy(g,i.pt0),r.copy(v,i.pt1),r.copy(m,i.pt2),i.n0||(i.n0=h.create(),r.normalize(i.n0,g)),i.n1||(i.n1=h.create(),r.normalize(i.n1,v)),i.n2||(i.n2=h.create(),r.normalize(i.n2,m)),p=r.dot(i.n0,i.n1),s=r.dot(i.n1,i.n2),o=r.dot(i.n0,i.n2),p<b||s<b||o<b){if(a=Math.min(p,s,o),!isNaN(a)&&null!=a)if(a==p){f++,d=.5*(g[0]+v[0]),u=.5*(g[1]+v[1]),c=.5*(g[2]+v[2]),l=.5*(i.pt00[0]+i.pt11[0]),x=.5*(i.pt00[1]+i.pt11[1]);var E=h.fromValues(d,u,c);r.normalize(E,E),t.push({pt0:i.pt0,pt1:[d,u,c],pt2:i.pt2,pt00:i.pt00,pt11:[l,x],pt22:i.pt22,index0:i.index0,index1:y+f,index2:i.index2,n0:i.n0,n1:E,n2:i.n2}),t.push({pt0:[d,u,c],pt1:i.pt1,pt2:i.pt2,pt00:[l,x],pt11:i.pt11,pt22:i.pt22,index0:y+f,index1:i.index1,index2:i.index2,n0:E,n1:i.n1,n2:i.n2}),e.push(l,x,D,this.index,_.Up,this.center[0],this.center[1]),n.push(y+f,i.index0,i.index1)}else if(a==s){f++,d=.5*(v[0]+m[0]),u=.5*(v[1]+m[1]),c=.5*(v[2]+m[2]),l=.5*(i.pt22[0]+i.pt11[0]),x=.5*(i.pt22[1]+i.pt11[1]);var E=h.fromValues(d,u,c);r.normalize(E,E),t.push({pt0:i.pt0,pt1:i.pt1,pt2:[d,u,c],pt00:i.pt00,pt11:i.pt11,pt22:[l,x],index0:i.index0,index1:i.index1,index2:y+f,n0:i.n0,n1:i.n1,n2:E}),t.push({pt0:i.pt0,pt1:[d,u,c],pt2:i.pt2,pt00:i.pt00,pt11:[l,x],pt22:i.pt22,index0:i.index0,index1:y+f,index2:i.index2,n0:i.n0,n1:E,n2:i.n2}),e.push(l,x,D,this.index,_.Up,this.center[0],this.center[1]),n.push(y+f,i.index1,i.index2)}else if(a==o){f++,d=.5*(g[0]+m[0]),u=.5*(g[1]+m[1]),c=.5*(g[2]+m[2]),l=.5*(i.pt22[0]+i.pt00[0]),x=.5*(i.pt22[1]+i.pt00[1]);var E=h.fromValues(d,u,c);r.normalize(E,E),t.push({pt0:i.pt0,pt1:i.pt1,pt2:[d,u,c],pt00:i.pt00,pt11:i.pt11,pt22:[l,x],index0:i.index0,index1:i.index1,index2:y+f,n0:i.n0,n1:i.n1,n2:E}),t.push({pt0:[d,u,c],pt1:i.pt1,pt2:i.pt2,pt00:[l,x],pt11:i.pt11,pt22:i.pt22,index0:y+f,index1:i.index1,index2:i.index2,n0:E,n1:i.n1,n2:i.n2}),e.push(l,x,D,this.index,_.Up,this.center[0],this.center[1]),n.push(y+f,i.index2,i.index0)}}else n.push(i.index0,i.index1,i.index2)},_subdivision2:function(t,e,n,i,r,p){for(var s,o,a,d,h,u,c=n.length/3,l=0,x=0;x<c;x++)d=n[l++],h=n[l++],u=n[l++],s=3*d,o=3*h,a=3*u,this._doSubdivision([{pt0:[e[s],e[s+1],e[s+2]],pt1:[e[o],e[o+1],e[o+2]],pt2:[e[a],e[a+1],e[a+2]],pt00:[t[s],t[s+1]],pt11:[t[o],t[o+1]],pt22:[t[a],t[a+1]],index0:d+i,index1:h+i,index2:u+i}],r,p)},destroy:function(){this.isFulfilled()||this.reject()}});return E});