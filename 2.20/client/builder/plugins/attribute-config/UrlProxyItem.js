// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define(["dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/Evented","./AppProxyUtil"],function(b,f,c,h,d){b=b([h],{appProxyManager:null,appProxies:null,title:"",sourceUrl:"",proxyUrl:"",proxyId:"",premium:!0,consumeCredits:!1,hitsPerInterval:0,intervalSeconds:0,constructor:function(a){c.mixin(this,a);this.premium=d.isPremium(this.sourceUrl);this.consumeCredits=d.consumesCredits(this.sourceUrl)},isInAppProxies:function(){return f.some(this.appProxies,c.hitch(this,function(a){return a.sourceUrl===
this.sourceUrl}))},createProxy:function(){if(this.premium||this.consumeCredits)if(d.urlExists(this.appProxyManager,this.sourceUrl)&&this.isInAppProxies())this.emit("processError",this.nls.alreadyProxied);else{this._startProcess();try{d.createProxy(this.appProxyManager,this.sourceUrl,this.hitsPerInterval,this.intervalSeconds).then(c.hitch(this,function(a){this.proxyUrl=a.proxyUrl;this.proxyId=a.proxyId;this.useProxy=!0;this.premium=a.premium;this.consumeCredits=a.consumeCredits;this._stopProcess();
this.emit("proxyCreated",{sourceUrl:this.sourceUrl,proxyUrl:this.proxyUrl,proxyId:this.proxyId,hitsPerInterval:this.hitsPerInterval,intervalSeconds:this.intervalSeconds,premium:this.premium,consumeCredits:this.consumeCredits,title:this.title,useProxy:!0})})).otherwise(c.hitch(this,function(){this._stopProcess()}))}catch(a){this.emit("processError",a),this._stopProcess()}}else this.emit("processError",this.nls.notValidPremiumUrl)},deleteProxy:function(){this._startProcess();if(this.appProxyManager&&
this.proxyId)try{this.appProxyManager.deleteProxies([{proxyId:this.proxyId}]).then(c.hitch(this,function(a){var g=f.some(a,c.hitch(this,function(e){return e.sourceUrl===this.sourceUrl&&!1===e.proxied}));g||(g=f.every(a,c.hitch(this,function(e){return e.sourceUrl!==this.sourceUrl})));g?(this.proxyId=this.proxyUrl="",this.emit("proxyDeleted",this.sourceUrl)):this.emit("processError",this.nls.deleteProxyFailed+" "+this.sourceUrl);this._stopProcess()}),c.hitch(this,function(){this.emit("processError",
this.nls.deleteProxyFailed+" "+this.sourceUrl);this._stopProcess()}))}catch(a){this.emit("processError",this.nls.deleteProxyFailed+" "+this.sourceUrl),this._stopProcess()}else this.emit("processError",this.nls.deleteProxyFailed+" "+this.sourceUrl),this._stopProcess()},_startProcess:function(){this.emit("processStart")},_stopProcess:function(){this.emit("processEnd")}});b.PROXY_CREATED="proxyCreated";b.PROCESS_START="processStart";b.PROXY_DELETED="proxyDeleted";b.PROCESS_END="processEnd";b.PROCESS_ERROR=
"processError";return b});