// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define(["dojo/_base/array","dojo/Deferred","jimu/portalUtils","esri/dijit/AppProxySettings"],function(p,l,t,u){function m(a){return r.isPremium(a)}function n(a){return r.isSubscriber(a)}function v(a){var b=new l;if(a){a=[].concat(a.operationalLayers,a.baseMap&&a.baseMap.baseMapLayers);var d=[],f={},e;p.forEach(a,function(c){if(c&&c.url){var g=c.url;var k=document.createElement("a");k.href=g;g=m(k.host);k=n(k.host);if(g||k)f[c.url]?(e=f[c.url],e.title=e.title+", "+(c.title||c.name)):(e={sourceUrl:c.url,
title:c.title||c.name,premium:g,consumeCredits:k,useProxy:!1},d.push(e),f[c.url]=e)}});b.resolve(d)}else b.resolve([]);return b}var r=new u({proxyManagerOptions:{appid:window.appInfo.id}}),h={queryForSecureServicesInMap:function(a,b){try{return t.getPortal(a).getItemData(b).then(function(d){return v(d)},function(){return[]})}catch(d){return a=new l,a.resolve([]),a}},isLimitedProxy:function(a){return a?!isNaN(a.hitsPerInterval)&&!isNaN(a.intervalSeconds)&&0<a.intervalSeconds&&0<a.hitsPerInterval:!1},
findProxy:function(a,b){var d;a=a||[];b=b||{};p.some(a,function(f){if(f.sourceUrl===b.sourceUrl)return d=f,!0});return d},urlExists:function(a,b){return p.some(a.proxies,function(d){return d.sourceUrl===b&&!1!==d.proxied})},updateProxy:function(a,b,d,f){var e=new l;h.isLimitedProxy({hitsPerInterval:d,intervalSeconds:f})?(b.hitsPerInterval=d,b.intervalSeconds=f):(delete b.hitsPerInterval,delete b.intervalSeconds);a.updateProxy(b).then(function(c){(foundProxy=h.findProxy(c,b))?(foundProxy.premium=m(b.sourceUrl),
foundProxy.consumeCredits=n(b.sourceUrl),e.resolve(foundProxy)):e.reject("update proxy failed.")}).otherwise(function(c){e.reject(c)});return e},createProxy:function(a,b,d,f){var e,c=new l,g={};var k=m(b);var w=n(b);if(e=h.findProxy(a.proxies,{sourceUrl:b}))return h.updateProxy(a,e,d,f);g.sourceUrl=b;h.isLimitedProxy({hitsPerInterval:d,intervalSeconds:f})&&(g.hitsPerInterval=d,g.intervalSeconds=f);a.createProxies([g]).then(function(q){(e=h.findProxy(q,{sourceUrl:b}))?(e.premium=k,e.consumeCredits=
w,c.resolve(e)):c.reject("create proxy failed.")}).otherwise(function(q){c.reject(q)});return c}};h.isPremium=m;h.consumesCredits=n;return h});