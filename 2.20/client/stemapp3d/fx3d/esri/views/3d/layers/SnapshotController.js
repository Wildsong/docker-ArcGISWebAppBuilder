/**
 * Copyright @ 2021 Esri.
 * All rights reserved under the copyright laws of the United States and applicable international laws, treaties, and conventions.
 */
define(["esri/config","esri/core/Accessor","esri/core/Error","esri/core/Evented","esri/core/Handles","esri/core/Logger","esri/core/Promise","esri/core/promiseUtils","esri/geometry/support/WKIDUnitConversion","./GraphicsManager","./Graphics3DVerticalScale"],function(e,t,r,i,a,n,s,u,l,o,h){function c(e){var t,r,i;if(e&&("object"==typeof e?(t=e.wkid,r=e.wkt):"number"==typeof e?t=e:"string"==typeof e&&(r=e)),t)i=_.values[_[t]];else if(r&&r.search(/^PROJCS/i)!==-1){var a=y.exec(r);a&&a[1]&&(i=parseFloat(a[1].split(",")[1]))}return i}function d(t,r){var i=r||t.extent,a=t.width,n=c(i&&i.spatialReference);return i&&a?i.width/a*(n||p)*f*e.screenDPI:0}var g=n.getLogger("esri.layers.graphics.controllers.SnapshotController"),f=39.37,p=6378137*Math.PI/180,y=/UNIT\[([^\]]+)\]\]$/i,_=l,m=s.EsriPromiseMixin(i.EventedMixin(t)).createSubclass({declaredClass:"esri.layers.graphics.controllers.SnapshotController",constructor:function(e){var t=this;return t.type="snapshot",t._gManager=null,t._verticalScale=null,t._handles=new a,t._source=null,t._started=!1,t._pendingQueries=new Map,t.extent=null,t.hasAllFeatures=!1,t.hasFeatures=!1,t.layer=null,t.layerView=null,t.maxPageSize=null,t.defaultReturnZ=void 0,t.defaultReturnM=void 0,t.pageSize=null,t.paginationEnabled=!1,t._cancelErrorMsg="SnapshotController: query cancelled",t._featureResolution={value:.25,scale:945},t._maxFeatures={point:16e3,multipoint:8e3,polyline:4e3,polygon:4e3,multipatch:4e3},t.layer=e.layer,t.layerView=e.layerView,t.maxPageSize=e.maxPageSize,t.graphics=e.graphics,t},initialize:function(){var e=this,t=this.layer.when(function(){return e._verifyCapabilities()}).then(function(){return e._init()});this.addResolvingPromise(t)},destroy:function(){this.cancelQuery(),this._gManager&&(this._gManager.destroy(),this._gManager=null),this._handles.destroy(),this._handles=null,this._pendingQueries=null},properties:{updating:{value:null,dependsOn:["_pendingQueries"],get:function(){return!!(this._pendingQueries&&this._pendingQueries.size>0)}},graphics:{value:null,set:function(e){var t=this._get("graphics");t!==e&&(this._handles.remove("graphics"),e&&(this._collectionChanged({added:e.toArray(),removed:t&&t.toArray()}),this._handles.add(e.on("change",this._collectionChanged.bind(this)),"graphics")),this._set("graphics",e))}}},cancelQuery:function(){var e=this;this._pendingQueries&&(this._pendingQueries.forEach(function(t,r){t.isFulfilled()||t.cancel(new Error(e._cancelErrorMsg))}),this._pendingQueries.clear(),this.notifyChange("updating"))},refresh:function(){this.isResolved()&&this._started&&this._queryFeatures()},startup:function(){this._started||(this._started=!0,this._resolutionParams=this._getResolutionParams(),this._queryFeatures())},update:function(){this.startup()},_init:function(){var e=this.layer;this.paginationEnabled=!!e.get("capabilities.query.supportsPagination"),this._source=e.source;var t=e.maxRecordCount||4e3;this.pageSize=null==this.maxPageSize?t:Math.min(t,this.maxPageSize),this._gManager=new o({graphics:this.graphics,objectIdField:e.objectIdField}),this._verticalScale=new h({sourceSpatialReference:e.spatialReference,destSpatialReference:this.layerView.view.spatialReference}),this._setupStateWatchers()},_getResolutionParams:function(){var e,t=this.layer,r=t.get("capabilities.query.supportsQuantization");if("polyline"===t.geometryType||"polygon"===t.geometryType){var i=c(this.layerView.view.spatialReference);if(null==i);else{var a=this._featureResolution.scale,n=this._featureResolution.value/i;a=t.maxScale?t.maxScale:t.minScale?Math.min(a,t.minScale):Math.min(a,d(this.layerView.view,t.fullExtent)),e=n/this._featureResolution.scale*a}}return e?{maxAllowableOffset:r?null:e,quantizationParameters:r?{mode:"view",originPosition:"upperLeft",tolerance:e,extent:t.fullExtent}:null}:null},_setupStateWatchers:function(){var e=this;this._handles.add([this.watch("extent",this.refresh.bind(this)),this.layer.watch("outFields",function(t,r){if(t&&r){if(r.indexOf("*")!==-1)return;t.sort(),r.sort(),JSON.stringify(t)!==JSON.stringify(r)&&e.refresh()}else e.refresh()}),this.layer.watch("definitionExpression, historicMoment",this.refresh.bind(this)),this.layer.on("edits",this._editsHandler.bind(this))])},_createQueryParams:function(){var e=this.layer,t=this.layerView,r=e.createQuery();r.outSpatialReference=t.view.spatialReference,r.geometry=this.extent;var i=e.capabilities&&e.capabilities.data;return i&&i.supportsZ&&null==r.returnZ&&null!=this.defaultReturnZ&&(r.returnZ=this.defaultReturnZ),i&&i.supportsM&&null==r.returnM&&null!=this.defaultReturnM&&(r.returnM=this.defaultReturnM),r.set(this._resolutionParams),this.paginationEnabled&&(r.start=0,r.num=this.pageSize),r},_queryFeatures:function(){this.cancelQuery(),this.hasAllFeatures=this.hasFeatures=!1,this._gManager.beginPagedUpdate(),this.emit("query-start"),this._executeQuery(this._createQueryParams())},_executeQuery:function(e){var t=this,r=this._source.queryFeatures(e),i=this._gManager.createIntentToAdd();this._querySetup(i,r),r.then(this._processFeatureSet.bind(this,e,i))["catch"](function(e){return t._queryError(i,e)}).then(function(){return t._queryTeardown(i)},function(){return t._queryTeardown(i)})},_hydrate:function(e,t,r){if(e){var i,a,n=e.translate[0],s=e.translate[1],u=e.scale[0],l=e.scale[1],o=function(e){return e*u+n},h=function(e){return s-e*l},c=function(e,t,r){return"esriGeometryPoint"===e?function(e){e.x=t(e.x),e.y=r(e.y)}:"polyline"===e||"polygon"===e?function(e){var i,a,n,s,u,l,o,h,c=e.rings||e.paths;for(i=0,a=c.length;i<a;i++)for(u=c[i],n=0,s=u.length;n<s;n++)l=u[n],n>0?(o+=l[0],h+=l[1]):(o=l[0],h=l[1]),l[0]=t(o),l[1]=r(h)}:"extent"===e?function(e){e.xmin=t(e.xmin),e.ymin=r(e.ymin),e.xmax=t(e.xmax),e.ymax=r(e.ymax)}:"multipoint"===e?function(e){var i,a,n,s,u,l=e.points;for(i=0,a=l.length;i<a;i++)n=l[i],i>0?(s+=n[0],u+=n[1]):(s=n[0],u=n[1]),n[0]=t(s),n[1]=r(u)}:void 0}(t,o,h);for(i=0,a=r.length;i<a;i++)r[i].geometry&&c(r[i].geometry)}},_processFeatureSet:function(e,t,r){r.transform&&this._hydrate(r.transform,r.geometryType,r.features);var i=r.exceededTransferLimit,a=r.features,n=this._maxFeatures[this.layer.geometryType]||0,s=a?a.length:0,u=this._gManager.numGraphics+s,l=u>=n;if(l){g.warn('Feature limit exceeded on layer "',this.layer.title,'". Not all features are shown.');var o=u-n;o&&a.splice(s-o,o)}var h=!(!i||!this.paginationEnabled||l)&&this._queryNextPage(e);return this._verticalScale.adjust(a),a&&this._gManager.addPage(a,t),this.hasFeatures=!0,h||(this._gManager.endPagedUpdate(),this.hasAllFeatures=!i,this.emit("query-end",{success:!0})),r},_queryNextPage:function(e){return e.start+=this.pageSize,this._executeQuery(e),!0},_queryError:function(e,t){if(t&&"cancel"===t.dojoType&&!this.hasFeatures?this._gManager.revertPagedUpdate():this._gManager.endPagedUpdate(),this.emit("query-end",{success:!1}),t&&"cancel"===t.dojoType)return u.reject(t);var i=new r("snapshotcontroller:tile-request-failed","Failed to query for features",{error:t});return g.error(i),u.reject(i)},_querySetup:function(e,t){this._pendingQueries.set(e,t),this.notifyChange("updating")},_queryTeardown:function(e){this._gManager.removeIntent(e),this._pendingQueries["delete"](e),this.notifyChange("updating")},_processRefetch:function(e,t){var r=t.features;r&&this._gManager.add(r,e)},_refetchError:function(e,t){},_verifyCapabilities:function(){if(!this.layer.get("capabilities.operations.supportsQuery"))throw new r("graphicscontroller:query-capability-required","Service requires query capabilities to be used as a feature layer",{layer:this.layer})},_collectionChanged:function(e){var t=e.added;if(t)for(var r=0;r<t.length;r++)t[r].layer=this.layer,t[r].sourceLayer=this.layer;if(t=e.removed)for(var r=0;r<t.length;r++)t[r].layer=null,t[r].sourceLayer=null},_editsHandler:function(e){var t=this,r=function(e){return e.objectId},i=e.deletedFeatures.map(r);this._gManager["delete"](i);var a=e.addedFeatures.concat(e.updatedFeatures).map(r);if(a.length){var n=this._createQueryParams();n.objectIds=a;var s=this._source.queryFeatures(n),u=this._gManager.createIntentToAdd(a);this._querySetup(u,s),s.then(this._processRefetch.bind(this,u))["catch"](this._refetchError.bind(this,u)).then(function(){return t._queryTeardown(u)},function(){return t._queryTeardown(u)})}}});return m});